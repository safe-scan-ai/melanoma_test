<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKIN SCAN - Melanoma Detection Study</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #f76246;
            --primary-dark: #d94e35;
            --primary-light: #ff8a70;
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --accent-yellow: #fbbf24;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --border-color: #3d3d3d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 30% 20%, rgba(247, 98, 70, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(247, 98, 70, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-stats {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.85rem;
        }

        .header-stat {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .header-stat.correct { color: var(--accent-green); }
        .header-stat.incorrect { color: var(--accent-red); }

        .case-counter {
            background: var(--primary);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }

        .screen { display: none; }
        .screen.active { display: block; }

        /* WELCOME SCREEN */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 480px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }

        .welcome-logo {
            font-family: 'Space Mono', monospace;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; text-align: left; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.85rem; color: var(--text-secondary); }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 20px rgba(247, 98, 70, 0.2); }
        select.input-field { cursor: pointer; }

        .consent-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
            margin: 1.5rem 0;
            text-align: left;
        }

        .consent-box label {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .consent-box input[type="checkbox"] { width: 18px; height: 18px; margin-top: 1px; accent-color: var(--primary); flex-shrink: 0; }

        .btn {
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 10px 30px rgba(247, 98, 70, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* QUIZ SCREEN */
        .quiz-screen {
            padding-top: 70px;
            min-height: 100vh;
        }

        .quiz-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.5rem;
            height: calc(100vh - 90px);
        }

        @media (max-width: 1024px) { 
            .quiz-layout { 
                grid-template-columns: 1fr; 
                height: auto;
            }
        }

        .image-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            min-height: 500px;
            position: relative;
        }

        .image-container img { 
            max-width: 100%; 
            max-height: calc(100vh - 180px); 
            object-fit: contain; 
        }

        .image-loading { color: var(--text-secondary); font-size: 1.2rem; }
        .image-error { color: var(--accent-red); text-align: center; padding: 2rem; }

        .control-panel { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
        }

        .timer-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-label { font-size: 0.8rem; color: var(--text-secondary); }
        .timer-value { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--primary); }

        .answer-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .answer-section h3 {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .answer-buttons { display: flex; flex-direction: column; gap: 0.75rem; }

        .answer-btn {
            padding: 1.25rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .answer-btn:hover:not(:disabled) { border-color: var(--accent-green); background: rgba(74, 222, 128, 0.1); transform: scale(1.02); }
        .answer-btn.melanoma:hover:not(:disabled) { border-color: var(--primary); background: rgba(247, 98, 70, 0.1); }
        .answer-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .answer-btn.selected { pointer-events: none; }
        .answer-btn.selected.correct { border-color: var(--accent-green); background: rgba(74, 222, 128, 0.2); }
        .answer-btn.selected.incorrect { border-color: var(--accent-red); background: rgba(248, 113, 113, 0.2); }

        .feedback {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            display: none;
            text-align: center;
        }

        .feedback.show { display: block; animation: fadeIn 0.3s ease; }
        .feedback.correct { background: rgba(74, 222, 128, 0.15); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .feedback.incorrect { background: rgba(248, 113, 113, 0.15); border: 1px solid var(--accent-red); color: var(--accent-red); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .progress-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
        }

        .progress-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); }
        .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s ease; }

        .keyboard-hint {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .keyboard-hint kbd {
            background: var(--bg-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            margin: 0 0.2rem;
        }

        /* RESULTS SCREEN */
        .results-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem 0; }

        .results-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }

        .results-header { text-align: center; margin-bottom: 1.5rem; }

        .results-logo {
            font-family: 'Space Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .results-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.3rem; }
        .results-subtitle { color: var(--text-secondary); font-size: 0.9rem; }

        .score-display { text-align: center; margin-bottom: 1.5rem; }
        .score-value { font-family: 'Space Mono', monospace; font-size: 3.5rem; font-weight: 700; color: var(--primary); }
        .score-label { color: var(--text-secondary); font-size: 0.85rem; }

        .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }

        .result-section { background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; }
        .result-section h4 { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }

        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .metric { text-align: center; }
        .metric-value { font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; }
        .metric-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.2rem; }

        .matrix-grid { display: grid; grid-template-columns: auto repeat(2, 1fr); gap: 0.4rem; }
        .matrix-cell { padding: 0.6rem; text-align: center; border-radius: 6px; font-size: 0.85rem; }
        .matrix-header { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; }
        .matrix-label { font-size: 0.7rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem; }

        .tp { background: rgba(74, 222, 128, 0.2); color: var(--accent-green); }
        .tn { background: rgba(247, 98, 70, 0.2); color: var(--primary); }
        .fp { background: rgba(251, 191, 36, 0.2); color: var(--accent-yellow); }
        .fn { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }

        .matrix-value { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; }
        .matrix-sublabel { font-size: 0.6rem; opacity: 0.7; }

        .submit-status {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.85rem;
        }

        .submit-status.success { color: var(--accent-green); }
        .submit-status.error { color: var(--accent-red); }
        .submit-status.pending { color: var(--accent-yellow); }

        .btn-restart { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); width: 100%; }
        .btn-restart:hover { border-color: var(--primary); background: rgba(247, 98, 70, 0.1); }

        .spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .container { padding: 0.75rem; }
            .welcome-card, .results-card { padding: 1.5rem; }
            .results-grid { grid-template-columns: 1fr; }
            .header-stats { gap: 0.75rem; font-size: 0.75rem; }
            .image-container { min-height: 350px; }
            .image-container img { max-height: 50vh; }
        }
    </style>
</head>
<body>
    <div id="welcomeScreen" class="screen active">
        <div class="container">
            <div class="welcome-screen">
                <div class="welcome-card">
                    <div class="welcome-logo">SKIN SCAN</div>
                    <p class="welcome-subtitle">
                        Test your melanoma detection skills using dermoscopic images.
                    </p>

                    <div class="input-group">
                        <label class="input-label">Your Name / ID</label>
                        <input type="text" id="userName" class="input-field" placeholder="e.g., Dr. Smith" autocomplete="off">
                    </div>

                    <div class="input-group">
                        <label class="input-label">Professional Background</label>
                        <select id="experienceLevel" class="input-field">
                            <option value="">Select...</option>
                            <option value="medical_student">Medical Student</option>
                            <option value="general_practitioner">General Practitioner</option>
                            <option value="dermatologist_junior">Dermatologist (&lt;5 years experience)</option>
                            <option value="dermoscopy_expert">Dermoscopy Expert (&gt;5 years experience)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Institution (optional)</label>
                        <input type="text" id="institution" class="input-field" placeholder="e.g., University Hospital" autocomplete="off">
                    </div>

                    <div class="consent-box">
                        <label>
                            <input type="checkbox" id="consentCheck">
                            I understand this is a research tool. My anonymized results will be recorded for analysis.
                        </label>
                    </div>

                    <button id="startBtn" class="btn btn-primary" disabled>
                        Start Evaluation ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="quizScreen" class="screen">
        <header class="header">
            <div class="logo">SKIN SCAN</div>
            <div class="header-stats">
                <div class="header-stat correct">‚úì <span id="statCorrect">0</span></div>
                <div class="header-stat incorrect">‚úó <span id="statIncorrect">0</span></div>
                <div class="header-stat">‚è± <span id="sessionTimer">00:00</span></div>
                <div class="case-counter"><span id="currentNum">1</span> / 300</div>
            </div>
        </header>
        
        <div class="quiz-screen">
            <div class="container">
                <div class="quiz-layout">
                    <div class="image-panel">
                        <div class="image-container" id="imageContainer">
                            <div class="image-loading"><div class="spinner"></div></div>
                        </div>
                    </div>

                    <div class="control-panel">
                        <div class="timer-section">
                            <span class="timer-label">Accuracy</span>
                            <span class="timer-value" id="statAccuracy">0%</span>
                        </div>

                        <div class="answer-section">
                            <h3>Is this Melanoma?</h3>
                            <div class="answer-buttons">
                                <button class="answer-btn" id="btnNotMelanoma" onclick="selectAnswer(false)">
                                    ‚úì NO - Not Melanoma
                                </button>
                                <button class="answer-btn melanoma" id="btnMelanoma" onclick="selectAnswer(true)">
                                    ‚ö† YES - Melanoma
                                </button>
                            </div>
                            <div class="feedback" id="feedback"></div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-header">
                                <span>Progress</span>
                                <span id="progressText">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="keyboard-hint">
                            <kbd>N</kbd> No &nbsp;|&nbsp; <kbd>M</kbd> Melanoma &nbsp;|&nbsp; <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resultsScreen" class="screen">
        <div class="container">
            <div class="results-screen">
                <div class="results-card">
                    <div class="results-header">
                        <div class="results-logo">SKIN SCAN</div>
                        <h1 class="results-title">Evaluation Complete</h1>
                        <p class="results-subtitle" id="resultsSubtitle"></p>
                    </div>
                    
                    <div class="score-display">
                        <div class="score-value" id="finalScore">0%</div>
                        <div class="score-label">Overall Accuracy</div>
                    </div>

                    <div class="results-grid">
                        <div class="result-section">
                            <h4>Performance</h4>
                            <div class="metrics-grid">
                                <div class="metric">
                                    <div class="metric-value" style="color: var(--accent-green)" id="finalSensitivity">0%</div>
                                    <div class="metric-label">Sensitivity</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value" style="color: var(--primary)" id="finalSpecificity">0%</div>
                                    <div class="metric-label">Specificity</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value" style="color: var(--accent-yellow)" id="finalPPV">0%</div>
                                    <div class="metric-label">PPV</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value" style="color: var(--text-secondary)" id="finalNPV">0%</div>
                                    <div class="metric-label">NPV</div>
                                </div>
                            </div>
                        </div>

                        <div class="result-section">
                            <h4>Confusion Matrix</h4>
                            <div class="matrix-grid">
                                <div class="matrix-cell"></div>
                                <div class="matrix-cell matrix-header">Pred: NO</div>
                                <div class="matrix-cell matrix-header">Pred: YES</div>
                                <div class="matrix-cell matrix-label">Actual: NO</div>
                                <div class="matrix-cell tn"><div class="matrix-value" id="matrixTN">0</div><div class="matrix-sublabel">TN</div></div>
                                <div class="matrix-cell fp"><div class="matrix-value" id="matrixFP">0</div><div class="matrix-sublabel">FP</div></div>
                                <div class="matrix-cell matrix-label">Actual: YES</div>
                                <div class="matrix-cell fn"><div class="matrix-value" id="matrixFN">0</div><div class="matrix-sublabel">FN</div></div>
                                <div class="matrix-cell tp"><div class="matrix-value" id="matrixTP">0</div><div class="matrix-sublabel">TP</div></div>
                            </div>
                        </div>
                    </div>

                    <div class="result-section" style="margin-bottom: 1rem;">
                        <h4>Summary</h4>
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-value" id="finalCorrect">0</div>
                                <div class="metric-label">Correct</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="finalIncorrect">0</div>
                                <div class="metric-label">Incorrect</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="finalTime">00:00</div>
                                <div class="metric-label">Total Time</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="avgTimePerCase">0s</div>
                                <div class="metric-label">Avg/Case</div>
                            </div>
                        </div>
                    </div>

                    <div class="submit-status" id="submitStatus">üì§ Submitting results...</div>

                    <button class="btn btn-restart" onclick="restartQuiz()">üîÑ Start New Evaluation</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTo6w0LW3BFNPJqkYi0_jPZAT1bW0jN4N4gTsg0LHhAF3KUur0_5YMNtHSOJgALrX0zA/exec';
        const AUTO_ADVANCE_DELAY = 800; // ms delay before auto-advance
        // ============================================

        let quizData = [];
        let currentIndex = 0;
        let userName = '';
        let experienceLevel = '';
        let institution = '';
        let answers = [];
        let imageBasePath = 'images/';
        let startTime = null;
        let timerInterval = null;

        const welcomeScreen = document.getElementById('welcomeScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultsScreen = document.getElementById('resultsScreen');

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            const userNameInput = document.getElementById('userName');
            const experienceSelect = document.getElementById('experienceLevel');
            const consentCheck = document.getElementById('consentCheck');
            const startBtn = document.getElementById('startBtn');

            const validateForm = () => {
                startBtn.disabled = !(userNameInput.value.trim().length >= 2 && experienceSelect.value && consentCheck.checked);
            };

            userNameInput.addEventListener('input', validateForm);
            experienceSelect.addEventListener('change', validateForm);
            consentCheck.addEventListener('change', validateForm);
            startBtn.addEventListener('click', startQuiz);
            userNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !startBtn.disabled) startQuiz(); });
        });

        async function loadData() {
            try {
                const response = await fetch('scientific_subset.json');
                quizData = await response.json();
                console.log(`Loaded ${quizData.length} dermoscopic cases`);
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading dataset.');
            }
        }

        function startQuiz() {
            userName = document.getElementById('userName').value.trim();
            experienceLevel = document.getElementById('experienceLevel').value;
            institution = document.getElementById('institution').value.trim();
            answers = new Array(quizData.length).fill(null);
            currentIndex = 0;
            startTime = new Date();

            welcomeScreen.classList.remove('active');
            quizScreen.classList.add('active');
            timerInterval = setInterval(updateTimer, 1000);
            loadQuestion();
        }

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('sessionTimer').textContent = `${minutes}:${seconds}`;
        }

        function loadQuestion() {
            const item = quizData[currentIndex];
            
            document.getElementById('currentNum').textContent = currentIndex + 1;

            const container = document.getElementById('imageContainer');
            container.innerHTML = '<div class="image-loading"><div class="spinner"></div></div>';
            
            const img = new Image();
            img.onload = () => { container.innerHTML = ''; container.appendChild(img); };
            img.onerror = () => { container.innerHTML = `<div class="image-error">‚ö†Ô∏è Cannot load: ${item.id}.jpg</div>`; };
            img.src = `${imageBasePath}${item.id}.jpg`;

            const btnMelanoma = document.getElementById('btnMelanoma');
            const btnNotMelanoma = document.getElementById('btnNotMelanoma');
            btnMelanoma.classList.remove('selected', 'correct', 'incorrect');
            btnNotMelanoma.classList.remove('selected', 'correct', 'incorrect');
            btnMelanoma.disabled = false;
            btnNotMelanoma.disabled = false;

            const feedback = document.getElementById('feedback');
            feedback.classList.remove('show', 'correct', 'incorrect');

            if (answers[currentIndex] !== null) showPreviousAnswer();

            updateProgress();
            updateStats();
        }

        function selectAnswer(isMelanoma) {
            const item = quizData[currentIndex];
            const isCorrect = isMelanoma === item.is_melanoma;
            
            answers[currentIndex] = {
                case_id: item.id,
                selected: isMelanoma,
                correct: isCorrect,
                actual: item.is_melanoma,
                category: item.category,
                diagnosis: item.diagnosis,
                timestamp: new Date().toISOString()
            };

            const btnMelanoma = document.getElementById('btnMelanoma');
            const btnNotMelanoma = document.getElementById('btnNotMelanoma');
            
            btnMelanoma.disabled = true;
            btnNotMelanoma.disabled = true;

            if (isMelanoma) {
                btnMelanoma.classList.add('selected', isCorrect ? 'correct' : 'incorrect');
            } else {
                btnNotMelanoma.classList.add('selected', isCorrect ? 'correct' : 'incorrect');
            }

            const feedback = document.getElementById('feedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'incorrect');
            feedback.textContent = isCorrect ? '‚úì Correct!' : `‚úó Actual: ${item.is_melanoma ? 'MELANOMA' : 'Not melanoma'}`;

            updateStats();

            // Auto-advance to next question
            setTimeout(() => {
                if (currentIndex < quizData.length - 1) {
                    currentIndex++;
                    loadQuestion();
                } else {
                    showResults();
                }
            }, AUTO_ADVANCE_DELAY);
        }

        function showPreviousAnswer() {
            const answer = answers[currentIndex];
            const item = quizData[currentIndex];
            
            const btnMelanoma = document.getElementById('btnMelanoma');
            const btnNotMelanoma = document.getElementById('btnNotMelanoma');
            
            btnMelanoma.disabled = true;
            btnNotMelanoma.disabled = true;

            if (answer.selected) {
                btnMelanoma.classList.add('selected', answer.correct ? 'correct' : 'incorrect');
            } else {
                btnNotMelanoma.classList.add('selected', answer.correct ? 'correct' : 'incorrect');
            }

            const feedback = document.getElementById('feedback');
            feedback.classList.add('show', answer.correct ? 'correct' : 'incorrect');
            feedback.textContent = answer.correct ? '‚úì Correct!' : `‚úó Actual: ${item.is_melanoma ? 'MELANOMA' : 'Not melanoma'}`;
        }

        function updateProgress() {
            const answered = answers.filter(a => a !== null).length;
            const percent = Math.round((answered / quizData.length) * 100);
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
        }

        function updateStats() {
            const answered = answers.filter(a => a !== null);
            const correct = answered.filter(a => a.correct).length;
            const incorrect = answered.length - correct;
            const accuracy = answered.length > 0 ? Math.round((correct / answered.length) * 100) : 0;

            document.getElementById('statCorrect').textContent = correct;
            document.getElementById('statIncorrect').textContent = incorrect;
            document.getElementById('statAccuracy').textContent = `${accuracy}%`;
        }

        function showResults() {
            clearInterval(timerInterval);
            const endTime = new Date();
            const totalSeconds = Math.floor((endTime - startTime) / 1000);

            quizScreen.classList.remove('active');
            resultsScreen.classList.add('active');

            const validAnswers = answers.filter(a => a !== null);
            const correct = validAnswers.filter(a => a.correct).length;
            const incorrect = validAnswers.length - correct;
            const percentage = Math.round((correct / validAnswers.length) * 100);

            let tp = 0, tn = 0, fp = 0, fn = 0;
            validAnswers.forEach(a => {
                if (a.actual && a.selected) tp++;
                else if (!a.actual && !a.selected) tn++;
                else if (!a.actual && a.selected) fp++;
                else if (a.actual && !a.selected) fn++;
            });

            const sensitivity = tp + fn > 0 ? Math.round((tp / (tp + fn)) * 100) : 0;
            const specificity = tn + fp > 0 ? Math.round((tn / (tn + fp)) * 100) : 0;
            const ppv = tp + fp > 0 ? Math.round((tp / (tp + fp)) * 100) : 0;
            const npv = tn + fn > 0 ? Math.round((tn / (tn + fn)) * 100) : 0;

            const expLabels = {
                'medical_student': 'Medical Student',
                'general_practitioner': 'General Practitioner', 
                'dermatologist_junior': 'Dermatologist (<5y)',
                'dermoscopy_expert': 'Dermoscopy Expert'
            };

            document.getElementById('resultsSubtitle').textContent = `${userName} ‚Ä¢ ${expLabels[experienceLevel] || experienceLevel}`;
            document.getElementById('finalScore').textContent = `${percentage}%`;
            document.getElementById('finalCorrect').textContent = correct;
            document.getElementById('finalIncorrect').textContent = incorrect;

            document.getElementById('matrixTP').textContent = tp;
            document.getElementById('matrixTN').textContent = tn;
            document.getElementById('matrixFP').textContent = fp;
            document.getElementById('matrixFN').textContent = fn;

            document.getElementById('finalSensitivity').textContent = `${sensitivity}%`;
            document.getElementById('finalSpecificity').textContent = `${specificity}%`;
            document.getElementById('finalPPV').textContent = `${ppv}%`;
            document.getElementById('finalNPV').textContent = `${npv}%`;

            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('finalTime').textContent = `${minutes}m ${seconds}s`;
            document.getElementById('avgTimePerCase').textContent = `${(totalSeconds / validAnswers.length).toFixed(1)}s`;

            submitResults({
                participant: userName,
                experience: experienceLevel,
                institution: institution,
                date: new Date().toISOString(),
                total_time_seconds: totalSeconds,
                accuracy: percentage,
                sensitivity, specificity, ppv, npv,
                tp, tn, fp, fn,
                correct, incorrect,
                total_cases: validAnswers.length
            });
        }

        async function submitResults(data) {
            const statusEl = document.getElementById('submitStatus');
            statusEl.className = 'submit-status pending';
            statusEl.textContent = 'üì§ Submitting results...';

            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
                statusEl.className = 'submit-status error';
                statusEl.innerHTML = '‚ö†Ô∏è Results not submitted (no server configured)';
                return;
            }

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                statusEl.className = 'submit-status success';
                statusEl.textContent = '‚úì Results submitted successfully!';
            } catch (error) {
                statusEl.className = 'submit-status error';
                statusEl.textContent = '‚ö†Ô∏è Could not submit results.';
            }
        }

        function restartQuiz() {
            resultsScreen.classList.remove('active');
            welcomeScreen.classList.add('active');
            document.getElementById('userName').value = '';
            document.getElementById('experienceLevel').value = '';
            document.getElementById('institution').value = '';
            document.getElementById('consentCheck').checked = false;
            document.getElementById('startBtn').disabled = true;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!quizScreen.classList.contains('active')) return;
            
            const btnMelanoma = document.getElementById('btnMelanoma');
            const btnNotMelanoma = document.getElementById('btnNotMelanoma');
            
            switch(e.key.toLowerCase()) {
                case 'arrowleft':
                    if (currentIndex > 0) { currentIndex--; loadQuestion(); }
                    break;
                case 'arrowright':
                    if (currentIndex < quizData.length - 1 && answers[currentIndex] !== null) { currentIndex++; loadQuestion(); }
                    break;
                case 'n':
                case '1':
                    if (!btnNotMelanoma.disabled) selectAnswer(false);
                    break;
                case 'm':
                case '2':
                    if (!btnMelanoma.disabled) selectAnswer(true);
                    break;
            }
        });
    </script>
</body>
</html>

